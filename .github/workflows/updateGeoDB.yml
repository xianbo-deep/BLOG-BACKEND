name: Update Geo Database
on:
  schedule:
    - cron: "0 3 1 * *"
  workflow_dispatch:


jobs:
  update:
    runs-on: self-hosted
    steps:


      - name: Download GeoLite2
        run: |
          set -euo pipefail

          URL="https://ghfast.top/https://github.com/P3TERX/GeoLite.mmdb/releases/latest/download/GeoLite2-City.mmdb"

          echo "Starting download from ghfast..."
          
          curl -fSL --retry 5 --retry-delay 10 -o GeoLite2-City.mmdb "$URL"

          # 安全检查：确认文件大于 10MB，防止下载到 404 页面或空文件
          FILE_SIZE=$(stat -c%s "GeoLite2-City.mmdb")
          if [ "$FILE_SIZE" -lt 10000000 ]; then
            echo "Error: File too small ($FILE_SIZE bytes). Download might have failed."
            exit 1
          fi
          
          echo "Download success. Size: $(du -h GeoLite2-City.mmdb | cut -f1)"

      - name: Install GeoLite2
        run: |
          sudo install -D -m 0644 GeoLite2-City.mmdb /usr/local/share/GeoIP/GeoLite2-City.mmdb
          
          echo "Database updated to /usr/local/share/GeoIP/GeoLite2-City.mmdb"

      - name: Download ip2region
        shell: bash
        run: |
          set -euxo pipefail
          
          REPO="https://github.com/lionsoul2014/ip2region.git"
          DEST_DIR="/usr/local/share/ip2region"
          TMP_DIR="${mktemp -d}"
          
          git clone --depth 1 "$REPO" "TMP_DIR/ip2region"
          
          cp "$TMP_DIR/ip2region/data/ip2region_v4.xdb" "DEST_DIR/ip2region_v4.xdb"
          cp "$TMP_DIR/ip2region/data/ip2region_v6.xdb" "DEST_DIR/ip2region_v6.xdb"
          
          rm -rf "TMP_DIR"
          
