name: Update GeoLite2
on:
  schedule:
    - cron: "0 3 1 * *"
  workflow_dispatch:


jobs:
  update:
    runs-on: self-hosted
    steps:


      - name: Download GeoLite2
        run: |
          set -euo pipefail

          URL="https://ghfast.top/https://github.com/P3TERX/GeoLite.mmdb/releases/latest/download/GeoLite2-City.mmdb"

          echo "Starting download from ghfast..."
          
          curl -fSL --retry 5 --retry-delay 10 -o GeoLite2-City.mmdb "$URL"

          # 安全检查：确认文件大于 10MB，防止下载到 404 页面或空文件
          FILE_SIZE=$(stat -c%s "GeoLite2-City.mmdb")
          if [ "$FILE_SIZE" -lt 10000000 ]; then
            echo "Error: File too small ($FILE_SIZE bytes). Download might have failed."
            exit 1
          fi
          
          echo "Download success. Size: $(du -h GeoLite2-City.mmdb | cut -f1)"

      - name: Upload to VPS
        run: |
          mkdir -p /usr/local/share/GeoIP/
          
          mv -f GeoLite2-City.mmdb /usr/local/share/GeoIP/GeoLite2-City.mmdb
          
          echo "Database updated to /usr/local/share/GeoIP/GeoLite2-City.mmdb"
